---
title: "Dression Cook out"
author: "Bonsoul"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```


```{r}
df1 <- read_csv("D:/Downloads/depressed_PHQ_dataset.edit.csv")

```

```{r}
library(labelled)

df1 <- df1 %>%
  rename(
    Feeling_sad        = PHQ1_feeling_sad,
    Crying_more        = PHQ2_crying_more,
    Loss_of_interest   = PHQ3_loss_interest,
    Less_time_friends  = PHQ4_less_time_friends,
    Sleep_problems     = PHQ5_sleep,
    Appetite_changes  = PHQ6_appetite,
    Tired              = PHQ7_tired,
    Feeling_bad        = PHQ8_feeling_bad,
    Concentration      = PHQ9_concentration,
    Self_harm_thoughts = PHQ10_self_harm
  )



```

```{r}
# Load libraries
library(dplyr)
library(gtsummary)

# Example: Recode PHQ responses to ordered factors
# Define common PHQ response levels
phq_levels <- c("Not at all", "Several days", "More than half the days", "Nearly every day")

# Recode all PHQ columns
phq_data_recoded <- df1%>%
  mutate(across(starts_with("PHQ"), 
                ~ factor(.x, levels = phq_levels, ordered = TRUE)))

# Descriptive analysis using gtsummary
descriptive_table <- phq_data_recoded %>%
  tbl_summary(
    type = all_categorical() ~ "categorical",
    statistic = all_categorical() ~ "{n} ({p}%)"
  )

# Print the table
descriptive_table

```


```{r}
library(officer)
library(flextable)

descriptive_table %>%
  as_flex_table() %>%
  save_as_docx(path = "PHQ_descriptive_table.docx")

```



```{r}
# Load dplyr
library(dplyr)

df <- df1 %>%
  mutate(across(
    c(
      Feeling_sad, Crying_more, Loss_of_interest, Less_time_friends,
      Sleep_problems, Appetite_changes, Tired, Feeling_bad,
      Concentration, Self_harm_thoughts
    ),
    ~ case_when(
      . == "Not at all"           ~ 0,
      . == "Several days"         ~ 1,
      . == "More than half the days" ~ 2,
      . == "Nearly every day"     ~ 3,
      TRUE                        ~ NA_real_
    )
  ))


```



```{r}
df10 <- df %>%
  rowwise() %>%
  mutate(
    PHQ_total = sum(c_across(c(
      Feeling_sad, Crying_more, Loss_of_interest, Less_time_friends,
      Sleep_problems, Appetite_changes, Tired, Feeling_bad,
      Concentration, Self_harm_thoughts
    )), na.rm = TRUE)
  ) %>%
  ungroup()

```



```{r}
library(dplyr)

df11 <- df10 %>%
  mutate(
    PHQ_severity = case_when(
      PHQ_total <= 3 ~ "Minimal / None",
      PHQ_total <= 10 ~ "Mild",
      PHQ_total <= 15 ~ "Moderate",
      PHQ_total <= 20 ~ "Moderately Severe",
      PHQ_total >= 20 ~ "Severe",
      TRUE ~ NA_character_
    )
  )


```



```{r}
severity_table_gt <- df11 %>%
  select(PHQ_severity) %>%
  tbl_summary(
    statistic = all_categorical() ~ "{n} ({p}%)",
    missing = "no"
  ) %>%
  modify_header(label ~ "**PHQ Severity**") %>%
  bold_labels()

severity_table_gt


```

```{r}
severity_table_gt %>%
  as_flex_table() %>%
  save_as_docx(path = "PHQ_Severity_table.docx")
```





```{r}
library(dplyr)
library(tidyr)

df10_clean <- df10 %>%
  mutate(across(
    starts_with("PHQ_item_"),
    ~ as.numeric(.)
  ))

item_severity <- df10_clean %>%
  pivot_longer(
    cols = starts_with("PHQ_item_"),
    names_to = "Item",
    values_to = "Score"
  ) %>%
  mutate(
    PHQ_severity = case_when(
      Score == 0 ~ "Minimal / None",
      Score == 1 ~ "Mild",
      Score == 2 ~ "Moderate",
      Score == 3 ~ "Moderately Severe",
      TRUE ~ NA_character_
    )
  )


```


```{r}
item_severity_table <- item_severity %>%
  count(Item, PHQ_severity) %>%
  group_by(Item) %>%
  mutate(
    percent = round(n / sum(n) * 100, 1),
    display = paste0(n, " (", percent, "%)")
  ) %>%
  ungroup()

```

```{r}
item_severity_table$PHQ_severity <- factor(
  item_severity_table$PHQ_severity,
  levels = c(
    "Minimal / None",
    "Mild",
    "Moderate",
    "Moderately Severe",
    "Severe"
  )
)

```



```{r}
item_severity %>%
  tbl_summary(
    by = Item,
    include = PHQ_severity,
    statistic = all_categorical() ~ "{n} ({p}%)",
    missing = "no"
  ) %>%
  bold_labels()

```



