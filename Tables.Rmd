---
title: "Perfect Tables"
author: "Bonsoul"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)

library(gtsummary)

```

```{r}
d <- trial %>% select(trt, age, grade, response)

```

```{r, summarise the data}
tbl_summary(d, by = trt )
```

```{r}
d %>%
  tbl_strata(
    strata = grade,
    ~.x %>%
      tbl_summary(by = trt)
  )
```

```{r, summarise statistical tests}
d %>%
  tbl_summary(by = trt) %>%
  add_p() %>%
  add_q() %>%
  add_overall() %>%
  add_n() %>%
  add_ci() %>%
  add_stat_label(
    label = all_continuous() ~ "Median (IQR)"
  )

```


```{r}
trial %>%
  tbl_summary(
    by = trt,
    statistic = all_continuous() ~ "{mean} ({sd})"
  ) %>%
  add_p(
    test = list(
      all_continuous() ~ "t.test",
      all_categorical() ~ "fisher.test"
    )
  )

```

```{r}
trial %>%
  tbl_summary(
    by = trt,
    statistic = list(
      age ~ "{mean} ({sd})",
      marker ~ "{mean} ({min}, {p25}, {p75}, {max})",
      stage ~ "{n} / {N} ({p}%)"
    )
  ) %>%
  add_p(
    test = list(
      age ~ "t.test",
      marker ~ "wilcox.test",
      stage ~ "fisher.test"
    )
  ) %>%
  separate_p_footnotes()

```

```{r}
trial_paired <- 
  trial %>%
  select(trt, marker, response) %>%
  group_by(trt) %>%
  mutate(id = row_number()) %>%
  ungroup()
```

```{r}
trial_paired %>%
  filter(complete.cases(.)) %>%
  group_by(id) %>%
  filter(n() ==2) %>%
  ungroup() %>%
  tbl_summary(by = trt, include = -id) %>%
  add_p(test = list(
    marker ~ "paired.t.test",
    response ~ "mcnemar.test"),
    group = id
  )
```

```{r}
trial %>%
  tbl_summary(
    by = trt,
    statistic = list(
      age ~ "{mean} ({sd})",
      marker ~ "{mean} ({min}, {p25}, {p75}, {max})",
      stage ~ "{n} / {N} ({p}%)"
    )
  ) %>%
  add_p(
    test = list(
      age ~ "t.test",
      marker ~ "wilcox.test",
      stage ~ "fisher.test"
    )
  ) %>%
  separate_p_footnotes()

```

```{r}
str(trial$age)
str(trial$marker)

```


```{r}
trial %>%
  tbl_summary(
    by = trt,
    statistic = list(
      age    ~ "{mean} ({sd})",
      marker ~ "{median} ({p25}, {p75})"
    ),
    label = grade ~ "New None ~ Tumor Grade",
    digits = all_continuous() ~ 1,
    #missing = "no",
    missing_text = "Missing values",
    type = list(
      response ~ "categorical",
      death ~ "categorical"
    ),
    sort = everything() ~ "frequency",
    percent = "cell",
    include = -ttdeath
  ) %>%
  
  add_p(pvalue_fun = ~ style_pvalue(.x, digits = 3))


```

#summarise regression models

```{r}
install.packages("broom")
```


```{r}

library(arm)
library(gtsummary)
library(broom)

bm <- arm::bayesglm(
  response ~ trt + age + grade,
  data = trial,
  family = binomial
)

bm_table <- tbl_regression(
  bm,
  exponentiate = TRUE,
  tidy_fun = broom::tidy
)

bm_table



```

```{r}
library(survival)

cm <- coxph(Surv(ttdeath, death) ~ trt + age + grade,
            data = trial)

cm_table <- tbl_regression(cm, exponentiate =  TRUE)


cm_table
```

```{r, univariate models}

uvlm_table <- trial %>%
  select(response, trt, age, grade) %>%
  tbl_uvregression(
    method = glm,
    y = response,
    method.args = list(family = binomial),
    exponentiate = TRUE
  )

uvlm_table

```

```{r}
uvcm_table <- tbl_uvregression(
  trial %>%
    
    select(ttdeath, death, trt, age, grade),
  method = coxph,
  y = Surv(ttdeath, death),
  exponentiate = TRUE
)


uvcm_table
```




