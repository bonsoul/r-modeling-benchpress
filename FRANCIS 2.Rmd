---
title: "Northern Mapping"
author: "Bonsoul"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
library(tidyverse)

```

```{r}
library(flextable)
library(dlookr)

```

```{r}
dat <- read_csv("D:/Documents/r-modeling-benchpress/Francis_RQ (2).csv")


```

```{r}
census_data <- read_csv("D:/Downloads/2019-population_census-report-per-county.csv")

```

```{r}
percent_nulls <- function(dat) {
  dat %>%
    summarise(
      across(
        everything(),
        ~ mean(is.na(.x)) * 100
      )
    ) %>%
    pivot_longer(
      cols = everything(),
      names_to = "variable",
      values_to = "percent_null"
    )
}

```

```{r}
percent_nulls(dat) %>%
  arrange(desc(percent_null)) %>%
  flextable() %>%
  autofit()

```

```{r, percentage of nulls : dropping 60% nulls}
vars_to_drop <- dat %>%
  summarise(across(everything(), ~ mean(is.na(.x)) * 100)) %>%
  pivot_longer(everything(),
               names_to = "variable",
               values_to = "percent_null") %>%
  filter(percent_null > 60) %>%
  pull(variable)

```


```{r, dataframe}
dat2 <- dat %>%
   select(-all_of(vars_to_drop))

```

```{r, County distribution}
dat2 %>%
   count(County) %>%
   mutate(
     percentage = round(n / sum(n) * 100, 2)
   ) %>%
   arrange(desc(n)) %>%
   flextable() %>%
   autofit()
```


```{r}
tb_county <- dat2 %>%
   group_by(County) %>%
   summarise(TB_cases = n()) %>%
   ungroup()

```


```{r, Gender distirbution}
dat2 <- dat2 %>%
  rename(Gender = `Sex (M/F)`) %>%
  mutate(
    Gender = str_trim(str_to_title(Gender)),
    Gender = case_when(
      Gender %in% c("F", "Female") ~ "Female",
      Gender %in% c("M", "Male")   ~ "Male",
      TRUE ~ Gender
    )
  )

```

```{r}
dat2 %>%
   count(`Gender`) %>%
   mutate(percentage = n / sum(n) * 100) %>%
   flextable()

```


```{r}
library(rnaturalearth)
library(rnaturalearthhires)
library(viridis)
library(RColorBrewer)
library(sf)
```


```{r}
shape_file <- st_read("shapefiles/County.shp")
```

```{r}
kenya_tb <- shape_file %>%
   left_join(tb_county, by = c("Name" = "County"))

```

```{r}
ggplot(kenya_tb) +
   geom_sf(aes(fill = TB_cases), color = "white", linewidth = 0.2) +
   scale_fill_distiller(palette = "YlOrRd", direction = 1, na.value = "grey90") +
   labs(title = "Distribution of TB Cases by County in Kenya", fill = "TB Cases") +
   theme_minimal()

```

```{r, standardise the 3 counties}
dat3 <- dat2 %>%
  mutate(
    County = trimws(County),  # remove extra spaces
    County = case_when(
      County == "Tharaka Nithi"     ~ "Tharaka-Nithi",
      County == "Elgeyo Marakwet"   ~ "Elgeyo-Marakwet",
      County == "Pokot"             ~ "West Pokot",
      TRUE ~ County
    )
  )


```

```{r}
tb_by_county <- dat3 %>%
  group_by(County) %>%
  summarise(
    TB_cases = n(),
    .groups = "drop"
  )

```

```{r, join}
tb_join <- tb_by_county %>%
  left_join(
    census_data %>% select(County, Total_Population19),
    by = "County"
  )


```

```{r}
tb_calc <- tb_join %>%
  mutate(
    overall_percent = round(100 * TB_cases / sum(TB_cases), 2),
    prevalence_per_100k = round((TB_cases / Total_Population19) * 1e5, 1)
  )


```

```{r}
tb_calc %>%
  select(County, Total_Population19, TB_cases, overall_percent, prevalence_per_100k) %>%
  arrange(desc(TB_cases)) %>%
  flextable() %>%
  colformat_num(j = c("Total_Population19", "TB_cases"), big.mark = ",") %>%
  colformat_num(j = c("overall_percent", "prevalence_per_100k"), digits = 1) %>%
  autofit()


```


```{r}
tb_calc %>%
  select(
    County,
    Total_Population19,
    TB_cases,
    overall_percent,
    prevalence_per_100k
  ) %>%
  arrange(desc(TB_cases)) %>%
  flextable() %>%
  set_header_labels(
    County = "County",
    Total_Population19 = "Population (2019)",
    TB_cases = "TB Cases",
    overall_percent = "Overall (%)",
    prevalence_per_100k = "Prevalence / 100,000"
  ) %>%
  autofit()


```



```{r}
library(ggplot2)

ggplot(
  tb_by_county,
  aes(
    x = TB_cases,
    y = reorder(County, TB_cases)
  )
) +
  geom_col(fill = "steelblue", width = 0.7) +
  geom_text(
    aes(label = scales::comma(TB_cases)),
    hjust = -0.1,
    size = 3
  ) +
  labs(
    title = "Tuberculosis (TB) Cases by County, Kenya",
    subtitle = "Count of reported TB cases",
    x = "Number of TB Cases",
    y = "County"
  ) +
  scale_x_continuous(
    labels = scales::comma,
    expand = expansion(mult = c(0, 0.15))  # space for labels
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11),
    panel.grid.major.y = element_blank()
  )


```

```{r}

tb_by_sex <- dat2 %>%
  group_by(County, Gender) %>%
  summarise(
    TB_cases = n(),
    .groups = "drop"
  )


```


```{r}
tb_sex_wide <- tb_by_sex %>%
  tidyr::pivot_wider(
    names_from = Gender,
    values_from = TB_cases,
    values_fill = 0
  )

```


```{r}
tb_sex_wide <- tb_sex_wide %>%
  mutate(
    F_to_M_ratio = round(
      ifelse(Male == 0, NA, Female / Male),
      2
    )
  )

```

```{r}
tb_sex_wide %>%
  select(County, Female, Male, F_to_M_ratio) %>%
  arrange(desc(F_to_M_ratio)) %>%
  flextable() %>%
  autofit()

```




```{r}
ggplot(
  tb_by_sex,
  aes(
    x = TB_cases,
    y = reorder(County, TB_cases),
    fill = Gender
  )
) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(
    aes(label = TB_cases),
    position = position_dodge(width = 0.8),
    hjust = -0.15,
    size = 3
  ) +
  labs(
    title = "TB Cases by County and Gender",
    subtitle = "Comparison of male and female TB burden by county",
    x = "Number of TB Cases",
    y = "County",
    fill = "Gender"
  ) +
  scale_fill_manual(
    values = c(
      "Female" = "salmon",
      "Male" = "steelblue"
    )
  ) +
  scale_x_continuous(
    expand = expansion(mult = c(0, 0.2))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11),
    panel.grid.major.y = element_blank()
  )

```






```{r}
library(dplyr)

dat5 <- dat3 %>%
  mutate(
    covid_period = case_when(
      Year < 2020 ~ "Pre-COVID",
      Year >= 2020 ~ "Post-COVID"
    )
  )

table(dat5$covid_period)

```


```{r}
tb_cases_covid <- dat5 %>%
  group_by(County, covid_period) %>%
  summarise(TB_cases = n(), .groups = "drop")

```


```{r}
tb_cases_covid <- tb_cases_covid %>%
  left_join(county_pop, by = "County")

```



```{r}
reporting_covid <- dat5 %>%
  group_by(covid_period, County, `Health Facility`, Year, Month) %>%
  summarise(records = n(), .groups = "drop")

head(reporting_covid)

```

```{r}
gender_county_covid <- dat5 %>%
  filter(!is.na(Gender)) %>%
  mutate(
    covid_period = ifelse(Year < 2020, "Pre-COVID", "Post-COVID")
  ) %>%
  group_by(covid_period, County, Gender) %>%
  summarise(n = n(), .groups = "drop") %>%
  tidyr::pivot_wider(
    names_from = Gender,
    values_from = n,
    values_fill = 0
  ) %>%
  mutate(
    F_to_M_ratio = ifelse(Male == 0, NA, Female / Male)
  )


```

```{r}
gender_county_covid %>% flextable()
```


```{r}

gender_county_clean <- gender_county_covid %>%
  filter(
    !is.na(County),
    County != "",
    !(Female == 0 & Male == 1 & F_to_M_ratio == 0)
  )

```


```{r}
gender_county_clean <- gender_county_clean %>%
  group_by(County) %>%
  filter(n() == 2) %>%   # keeps counties with both periods
  ungroup()

```


```{r}
gender_county_presentable <- gender_county_clean %>%
  arrange(County, covid_period) %>%
  mutate(F_to_M_ratio = round(F_to_M_ratio, 2))

```


```{r}

gender_county_presentable %>% flextable()

```




```{r}
gender_change <- gender_county_presentable %>%
  tidyr::pivot_wider(
    names_from = covid_period,
    values_from = F_to_M_ratio
  ) %>%
  mutate(change = `Post-COVID` - `Pre-COVID`)

ggplot(gender_change,
       aes(x = reorder(County, change), y = change)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Change in Female-to-Male Ratio After COVID-19",
    x = "",
    y = "Post âˆ’ Pre Difference"
  ) +
  theme_minimal()

```

