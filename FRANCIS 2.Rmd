---
title: "Northern Mapping"
author: "Bonsoul"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r, include=FALSE}
library(tidyverse)
library(flextable)
library(dlookr)
library(knitr)
library(kableExtra)
library(ggplot2)
library(plotly)
library(sf)

```

```{r, include=FALSE}
dat <- read_csv("D:/Documents/r-modeling-benchpress/Francis_RQ (2).csv")

census_data <- read_csv("D:/Downloads/2019-population_census-report-per-county.csv")
```


#checking nulls

```{r, include=FALSE}
percent_nulls <- function(dat) {
  dat %>%
    summarise(
      across(
        everything(),
        ~ mean(is.na(.x)) * 100
      )
    ) %>%
    pivot_longer(
      cols = everything(),
      names_to = "variable",
      values_to = "percent_null"
    )
}

```

```{r, Percentage of Missing Values by Variable, include=TRUE}
percent_nulls(dat) %>%
  arrange(desc(percent_null)) %>%
  mutate(
    percent_null = round(percent_null, 2)  
  ) %>%
  kable(
    col.names = c("Variable", "Percent Missing"),
    caption = "Percentage of Missing Values by Variable"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center"
  )

```

```{r, percentage of nulls : dropping 60% nulls, include=FALSE}
vars_to_drop <- dat %>%
  summarise(across(everything(), ~ mean(is.na(.x)) * 100)) %>%
  pivot_longer(everything(),
               names_to = "variable",
               values_to = "percent_null") %>%
  filter(percent_null > 60) %>%
  pull(variable)

```


```{r, dataframe, include=FALSE}
dat2 <- dat %>%
   select(-all_of(vars_to_drop))

```

```{r, County distribution}
dat2 %>%
   count(County) %>%
   mutate(
     percentage = round(n / sum(n) * 100, 2)
   ) %>%
   arrange(desc(n)) %>%
   flextable() %>%
   autofit()
```

```{r}
# Summarize counts per county
county_summary <- dat2 %>%
  count(County) %>%
  mutate(
    percentage = round(n / sum(n) * 100, 2)
  ) %>%
  arrange(desc(n))

# Add a total row
# Summarize counts per county
county_summary <- dat2 %>%
  count(County) %>%
  mutate(
    percentage = round(n / sum(n) * 100, 2),
    total_cases = sum(n)           # same total repeated for each row
  ) %>%
  arrange(desc(n))

```

```{r}
county_summary <- dat2 %>%
  filter(!is.na(County)) %>%             # remove rows with missing county
  count(County) %>%
  mutate(
    total_cases = sum(n),                # total TB cases repeated for each row
    percentage = round(n / total_cases * 100, 2)
  ) %>%
  arrange(desc(n)) %>%
  select(County, n, total_cases, percentage)  # reorder columns

```


```{r, table, include=TRUE}


# Print table with kableExtra
county_summary %>%
  kable(
    col.names = c("County", "Number of Patients", "Total TB Cases", "Percentage of Total"),
    caption = "TB Cases Distribution by County"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center"
  )


```



```{r,TB Cases Distribution by County, include=TRUE}

county_summary <- county_summary %>%
  mutate(County = factor(County, levels = rev(County)),
         n_thousands = n / 1000)  # convert to thousands

ggplot(county_summary, aes(x = County, y = n_thousands, fill = County)) +
  geom_col() +
  scale_fill_grey(start = 0.3, end = 0.8) +
  coord_flip() +
  labs(
    title = "TB Cases Distribution by County",
    x = "County",
    y = "Number of TB Patients (thousands)"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none") +
  scale_y_continuous(expand = c(0,0)) 

```

```{r, include=FALSE}

dat3 <- dat2 %>%
  mutate(
    County = recode(
      County,
      "Murang'a" = "Muranga",
      "Pokot" = "West Pokot"
    )
  )

```



```{r, include=FALSE}
tb_county <- dat3 %>%
   group_by(County) %>%
   summarise(TB_cases = n()) %>%
   ungroup()

```



```{r, include=FALSE}
shape_file <- st_read("shapefiles/County.shp")
```

```{r, include=FALSE}
kenya_tb <- shape_file %>%
   left_join(tb_county, by = c("Name" = "County"))

```

```{r, include=FALSE}


# Basic ggplot map
p <- ggplot(kenya_tb) +
  geom_sf(aes(
    fill = TB_cases,
    text = paste0(Name, "\nTB Cases: ", TB_cases)  # use correct county column
  ), color = "white", linewidth = 0.2) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1, na.value = "grey90") +
  labs(
    title = "Distribution of TB Cases by County in Kenya",
    fill = "TB Cases"
  ) +
  theme_minimal()

# Convert to interactive plot



```

```{r, include=TRUE}
ggplotly(p, tooltip = "text")
```


```{r, Gender distirbution, include=FALSE}
dat2 <- dat2 %>%
  rename(Gender = `Sex (M/F)`) %>%
  mutate(
    Gender = str_trim(str_to_title(Gender)),
    Gender = case_when(
      Gender %in% c("F", "Female") ~ "Female",
      Gender %in% c("M", "Male")   ~ "Male",
      TRUE ~ Gender
    )
  )

```

```{r, include=TRUE}
dat2 %>%
   count(`Gender`) %>%
   mutate(percentage = n / sum(n) * 100) %>%
   flextable()

```


```{r, include=FALSE}
library(rnaturalearth)
library(rnaturalearthhires)
library(viridis)
library(RColorBrewer)
library(sf)
```




```{r, standardise the 3 counties}
dat3 <- dat2 %>%
  mutate(
    County = trimws(County),  # remove extra spaces
    County = case_when(
      County == "Tharaka Nithi"     ~ "Tharaka-Nithi",
      County == "Elgeyo Marakwet"   ~ "Elgeyo-Marakwet",
      County == "Pokot"             ~ "West Pokot",
      TRUE ~ County
    )
  )


```

```{r,include=FALSE}
tb_by_county <- dat3 %>%
  group_by(County) %>%
  summarise(
    TB_cases = n(),
    .groups = "drop"
  )

```

```{r, join, include=FALSE}
tb_join <- tb_by_county %>%
  left_join(
    census_data %>% select(County, Total_Population19),
    by = "County"
  )


```

```{r, include=FALSE}
tb_calc <- tb_join %>%
  mutate(
    overall_percent = round(100 * TB_cases / sum(TB_cases), 2),
    prevalence_per_100k = round((TB_cases / Total_Population19) * 1e5, 1)
  )


```

```{r, include=FALSE}
tb_calc %>%
  select(County, Total_Population19, TB_cases, overall_percent, prevalence_per_100k) %>%
  arrange(desc(TB_cases)) %>%
  flextable() %>%
  colformat_num(j = c("Total_Population19", "TB_cases"), big.mark = ",") %>%
  colformat_num(j = c("overall_percent", "prevalence_per_100k"), digits = 1) %>%
  autofit()


```


```{r, include=TRUE}
tb_calc %>%
  select(
    County,
    Total_Population19,
    TB_cases,
    overall_percent,
    prevalence_per_100k
  ) %>%
  arrange(desc(TB_cases)) %>%
  flextable() %>%
  set_header_labels(
    County = "County",
    Total_Population19 = "Population (2019)",
    TB_cases = "TB Cases",
    overall_percent = "Overall (%)",
    prevalence_per_100k = "Prevalence / 100,000"
  ) %>%
  autofit()


```



```{r, include=FALSE}

tb_by_sex <- dat2 %>%
  group_by(County, Gender) %>%
  summarise(
    TB_cases = n(),
    .groups = "drop"
  )
```


```{r, include=FALSE}
tb_sex_wide <- tb_by_sex %>%
  tidyr::pivot_wider(
    names_from = Gender,
    values_from = TB_cases,
    values_fill = 0
  )

```


```{r, include=FALSE}
tb_sex_wide <- tb_sex_wide %>%
  mutate(
    F_to_M_ratio = round(
      ifelse(Male == 0, NA, Female / Male),
      2
    )
  )

```



```{r, Dender ratio to county, include=TRUE}
tb_sex_wide %>%
  select(County, Female, Male, F_to_M_ratio) %>%
  filter(!is.na(F_to_M_ratio)) %>%   
  arrange(desc(F_to_M_ratio)) %>%
  mutate(
    Female = round(Female, 0),
    Male = round(Male, 0),
    F_to_M_ratio = round(F_to_M_ratio, 2)
  ) %>%
  kable(
    col.names = c("County", "Female TB cases", "Male TB cases", "F:M Ratio"),
    caption = "TB Cases by Gender and Female-to-Male Ratio by County (NAs removed)"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center"
  )

```


```{r, pre and post covid, include=FALSE}

dat5 <- dat3 %>%
  mutate(
    covid_period = case_when(
      Year < 2020 ~ "Pre-COVID",
      Year >= 2020 ~ "Post-COVID"
    )
  )

table(dat5$covid_period)

```


```{r, include=FALSE}
dat5_summary <- dat5 %>%
  group_by(Year, covid_period) %>%
  summarise(n = n(), .groups = "drop")
```

```{r ,include=FALSE}

dat5_summary %>% flextable()

```

```{r, include=FALSE}
ggplot(dat5_summary, aes(x = Year, y = n, color = covid_period)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Trend Over Time by COVID Period",
    x = "Year",
    y = "Number of Records",
    color = "Period"
  ) +
  theme_minimal()

```

```{r, include=TRUE}
year_counts <- dat5 %>%
  count(Year)

ggplot(year_counts, aes(x = Year, y = n)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  geom_vline(xintercept = 2020, linetype = "dashed") +
  annotate("text", x = 2020, y = max(year_counts$n),
           label = "COVID starts", hjust = -0.1) +
  theme_minimal() +
  labs(
    title = "Time Trend with COVID Period Marker",
    x = "Year",
    y = "Number of Records"
  )

```



```{r}
tb_cases_covid <- dat5 %>%
  group_by(County, covid_period) %>%
  summarise(TB_cases = n(), .groups = "drop")

```


```{r,gender analysis, include=FALSE}
gender_county_covid <- dat5 %>%
  filter(!is.na(Gender)) %>%
  mutate(
    covid_period = ifelse(Year < 2020, "Pre-COVID", "Post-COVID")
  ) %>%
  group_by(covid_period, County, Gender) %>%
  summarise(n = n(), .groups = "drop") %>%
  tidyr::pivot_wider(
    names_from = Gender,
    values_from = n,
    values_fill = 0
  ) %>%
  mutate(
    F_to_M_ratio = ifelse(Male == 0, NA, Female / Male)
  )


```

```{r, include=FALSE}
gender_county_covid %>% flextable()
```


```{r, include=FALSE}
gender_county_clean <- gender_county_covid %>%
  filter(
    !is.na(County),
    County != "",
    !(Female == 0 & Male == 1 & F_to_M_ratio == 0)
  )

```


```{r, include=FALSE}
gender_county_clean <- gender_county_clean %>%
  group_by(County) %>%
  filter(n() == 2) %>%   # keeps counties with both periods
  ungroup()

```


```{r, include=FALSE}
gender_county_presentable <- gender_county_clean %>%
  arrange(County, covid_period) %>%
  mutate(F_to_M_ratio = round(F_to_M_ratio, 2))

```


```{r, include=TRUE}

gender_county_presentable %>% flextable()

```


```{r, include=FALSE}
gender_change <- gender_county_presentable %>%
  tidyr::pivot_wider(
    names_from = covid_period,
    values_from = F_to_M_ratio
  ) %>%
  mutate(change = `Post-COVID` - `Pre-COVID`)

ggplot(gender_change,
       aes(x = reorder(County, change), y = change)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Change in Female-to-Male Ratio After COVID-19",
    x = "",
    y = "Post − Pre Difference"
  ) +
  theme_minimal()

```


##Objective 2


```{r, include=FALSE}
library(dplyr)

dat6 <- dat5 %>%
  mutate(
    outcome = case_when(
      `Treatment Outcome` == "C"    ~ "Cured",
      `Treatment Outcome` == "TC"   ~ "Treatment completed",
      `Treatment Outcome` == "D"    ~ "Died",
      `Treatment Outcome` == "LTFU" ~ "Lost to follow-up",
      `Treatment Outcome` == "F"    ~ "Failed",
      `Treatment Outcome` == "TO"   ~ "Transferred out",
      `Treatment Outcome` %in% c("NC", "MT4") ~ "Not evaluated",
      is.na(`Treatment Outcome`) ~ "Missing",
      TRUE ~ "Other"
    )
  )

table(dat6$outcome)

```


```{r, include=FALSE}
tb_outcome_year <- dat6 %>%
  group_by(Year, outcome) %>%
  summarise(
    cases = n(),
    .groups = "drop"
  ) %>%
  arrange(Year, outcome)

tb_outcome_year %>% flextable()

```

```{r, include=FALSE}
tb_outcome_year <- tb_outcome_year %>%
  group_by(Year) %>%
  mutate(
    total_year = sum(cases),
    percent = round(100 * cases / total_year, 1)
  ) %>%
  ungroup()

```


```{r, table for treatment outcome from 2017 to 2022, include=TRUE}

tb_outcome_year_wide <- tb_outcome_year %>%
  select(Year, outcome, cases) %>%
  pivot_wider(
    names_from = outcome,
    values_from = cases,
    values_fill = 0
  )

tb_outcome_year_wide %>% flextable()

```


```{r, Mortality Analysis, include=FALSE}

death_year <- dat6 %>%
  filter(outcome == "Died") %>%
  count(Year)

```

```{r, include=FALSE}
ggplot(death_year, aes(x = Year, y = n)) +
  geom_line(size = 1.2, color = "#C0392B") +
  geom_point(size = 3, color = "#C0392B") +
  geom_vline(xintercept = 2020, linetype = "dashed", color = "grey40") +
  annotate("text", x = 2020, y = max(death_year$n),
           label = "COVID onset", hjust = -0.1, size = 4) +
  labs(
    title = "TB Mortality Trend by Year",
    x = "Year",
    y = "Number of Deaths"
  ) +
  theme_minimal(base_size = 13)

```

```{r, include=FALSE}
outcome_year <- dat6 %>%
  group_by(Year, outcome) %>%
  summarise(cases = n(), .groups = "drop")

```

```{r,TB Treatment Outcomes by Year, include=TRUE}
ggplot(outcome_year, aes(x = factor(Year), y = cases, fill = outcome)) +
  geom_col(width = 0.8) +
  labs(
    title = "TB Treatment Outcomes by Year",
    x = "Year",
    y = "Number of Patients",
    fill = "Outcome"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

```{r,Treatment Success Rate (Cured + Treatment Completed), include=FALSE}
success_year <- dat6 %>%
  filter(outcome %in% c("Cured", "Treatment completed", 
                        "Died", "Failed", "Lost to follow-up", "Transferred out")) %>%
  mutate(
    success = if_else(outcome %in% c("Cured", "Treatment completed"), 1, 0)
  ) %>%
  group_by(Year) %>%
  summarise(
    total = n(),
    success_rate = round(100 * mean(success), 1),
    .groups = "drop"
  )

```

```{r, include=TRUE}
ggplot(success_year, aes(x = Year, y = success_rate)) +
  geom_line(size = 1.2, color = "#1E8449") +
  geom_point(size = 3, color = "#1E8449") +
  geom_hline(yintercept = 90, linetype = "dotted", color = "grey40") +
  labs(
    title = "TB Treatment Success Rate by Year",
    x = "Year",
    y = "Success Rate (%)"
  ) +
  theme_minimal(base_size = 13)

```


```{r, include=FALSE}
covid_outcomes <- dat6 %>%
  filter(outcome %in% c("Cured", "Treatment completed", 
                        "Died", "Failed", "Lost to follow-up", "Transferred out")) %>%
  group_by(covid_period, outcome) %>%
  summarise(cases = n(), .groups = "drop") %>%
  group_by(covid_period) %>%
  mutate(percent = round(100 * cases / sum(cases), 1)) %>%
  ungroup()

```

```{r, include=TRUE}
ggplot(covid_outcomes, aes(x = covid_period, y = percent, fill = outcome)) +
  geom_col(width = 0.6) +
  labs(
    title = "TB Treatment Outcomes: Pre- vs Post-COVID",
    x = "",
    y = "Percentage of Patients",
    fill = "Outcome"
  ) +
  theme_minimal(base_size = 13)

```



```{r, mortality plot, include=FALSE}

theme_tb <- theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(size = 13),
    legend.title = element_text(face = "bold"),
    legend.position = "bottom"
  )

```


```{r, include=TRUE}
p_death <- ggplot(death_year, aes(x = Year, y = n)) +
  geom_line(size = 1.3, color = "#B03A2E") +
  geom_point(size = 3, color = "#B03A2E") +
  geom_vline(xintercept = 2020, linetype = "dashed", color = "grey40") +
  labs(
    title = "TB Mortality Trend by Year",
    x = "Year",
    y = "Number of Deaths"
  ) +
  theme_tb

p_death

```


```{r, include=FALSE}
ggsave("TB_Mortality_Trend.png", p_death,
       width = 8, height = 5, dpi = 300)

```


```{r,include=FALSE}
dat6 <- dat6 %>%
  mutate(died = if_else(outcome == "Died", 1, 0))

```

```{r, mortality by age group, include=FALSE}
# Create age groups
dat7 <- dat6 %>%
  mutate(age_group = case_when(
    `Date of Registration` < 15 ~ "<15",
    `Date of Registration` >= 15 & `Date of Registration` < 30 ~ "15-29",
    `Date of Registration` >= 30 & `Date of Registration` < 45 ~ "30-44",
    `Date of Registration` >= 45 & `Date of Registration` < 60 ~ "45-59",
    `Date of Registration` >= 60 ~ "60+",
    TRUE ~ NA_character_
  ))
```


```{r, include=FALSE}
age_gender_death <- dat7 %>%
  group_by(age_group, Gender) %>%
  summarise(deaths = sum(died, na.rm = TRUE),
            total = n(),
            mortality_rate = round(100*deaths/total,1),
            .groups = "drop")
```

```{r,include=TRUE}
age_gender_death %>% flextable()

```


```{r, include=TRUE}
ggplot(age_gender_death, aes(x = age_group, y = mortality_rate, fill = Gender)) +
  geom_col(position = "dodge") +
  labs(
    title = "Mortality Rate by Age Group and Gender",
    x = "Age Group",
    y = "Mortality Rate (%)",
    fill = "Gender"
  ) +
  theme_minimal(base_size = 14)
```


```{r, include=FALSE}
dat8 <- dat7 %>%
  mutate(
    # Convert to proper Date first
    DateReg = as.Date(`Date of Registration`, format = "%d-%b-%y"),
    # Then create month column
    month = floor_date(DateReg, "month")
  )

```

```{r, include=FALSE}
monthly_deaths <- dat8 %>%
  group_by(month) %>%
  summarise(deaths = sum(died, na.rm = TRUE), .groups = "drop")

```

```{r, include=FALSE}
monthly_deaths %>% flextable()
```

```{r, bar plot, include=TRUE}

ggplot(monthly_deaths, aes(x = month, y = deaths)) +
  geom_col(fill = "#C0392B") +
  geom_vline(xintercept = as.Date("2020-03-01"), linetype = "dashed", color = "grey40") +
  annotate("text", x = as.Date("2020-03-01"), y = max(monthly_deaths$deaths),
           label = "COVID onset", hjust = -0.1, vjust = -0.5, size = 4) +
  labs(
    title = "Monthly TB Deaths (Bar Plot)",
    x = "Month",
    y = "Number of Deaths"
  ) +
  theme_minimal(base_size = 14) +
  scale_x_date(date_labels = "%b-%Y", date_breaks = "2 months") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r, include=TRUE}
ggplot(monthly_deaths, aes(x = month, y = deaths)) +
  geom_line(color = "#C0392B", size = 1.2) +
  geom_point(color = "#C0392B", size = 2) +
  geom_vline(xintercept = as.Date("2020-03-01"), linetype = "dashed", color = "grey40") +
  annotate("text", x = as.Date("2020-03-01"), y = max(monthly_deaths$deaths),
           label = "COVID onset", hjust = -0.1, size = 4) +
  labs(
    title = "Monthly TB Deaths (Interrupted Time Series)",
    x = "Month",
    y = "Number of Deaths"
  ) +
  theme_minimal(base_size = 14)


```

##Case fatality per 100,000 TB cases


```{r, Case fatality per 100,000, include=FALSE}
abs_deaths <- dat8 %>%
  group_by(age_group, Gender) %>%
  summarise(
    deaths = sum(died, na.rm = TRUE),
    .groups = "drop"
  )

abs_deaths %>% flextable()

```

```{r, Case fatality per 100,000 TB cases, include=TRUE}
cfr_age_gender <- dat8 %>%
  group_by(age_group, Gender) %>%
  summarise(
    deaths = sum(died, na.rm = TRUE),
    tb_cases = n(),
    case_fatality_100k = round((deaths / tb_cases) * 100000, 1),
    .groups = "drop"
  )

cfr_age_gender %>% flextable()

```


```{r, include=TRUE}
ggplot(cfr_age_gender,
       aes(x = age_group, y = case_fatality_100k, fill = Gender)) +
  geom_col(position = "dodge") +
  labs(
    title = "TB Case Fatality per 100,000 Cases",
    x = "Age Group",
    y = "Deaths per 100,000 TB Cases",
    fill = "Gender"
  ) +
  theme_minimal(base_size = 14)

```


## TB Treatment Follow-up Outcomes Before, During, and After COVID-19


```{r, include=FALSE}
tb_outcomes_period <- dat8 %>%
  mutate(
    period = case_when(
      DateReg < as.Date("2020-03-01") ~ "Pre-COVID",
      DateReg >= as.Date("2020-03-01") & DateReg <= as.Date("2021-12-31") ~ "COVID",
      DateReg >= as.Date("2022-01-01") ~ "Post-COVID",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(period))


```


```{r, include=FALSE}
tb_outcomes_period <- tb_outcomes_period %>%
  mutate(
    followup_outcome = case_when(
      `Treatment Outcome` %in% c("C", "TC") ~ "Treatment success",
      `Treatment Outcome` == "LTFU" ~ "Lost to follow-up",
      `Treatment Outcome` == "D" ~ "Died",
      `Treatment Outcome` == "F" ~ "Failed",
      TRUE ~ "Other"
    )
  )

```

```{r, include=FALSE}
tb_summary_period <- tb_outcomes_period %>%
  group_by(period, followup_outcome) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(period) %>%
  mutate(percent = n / sum(n) * 100)

tb_summary_period %>% flextable()


```

```{r,TB Treatment Follow-up Outcomes Before, During, and After COVID-19, include=TRUE}
ggplot(tb_summary_period,
       aes(x = period, y = percent, fill = followup_outcome)) +
  geom_col(width = 0.7) +
  labs(
    title = "TB Treatment Follow-up Outcomes Before, During, and After COVID-19",
    x = "Period",
    y = "Percentage of patients",
    fill = "Outcome"
  ) +
  theme_minimal(base_size = 14)

```

```{r,completion_rate,  include=TRUE}
completion_rate <- tb_outcomes_period %>%
  mutate(completed = if_else(`Treatment Outcome` %in% c("C", "TC"), 1, 0)) %>%
  group_by(period) %>%
  summarise(
    completed = sum(completed),
    total = n(),
    completion_rate = completed / total * 100,
    .groups = "drop"
  )

completion_rate %>% flextable()

```


```{r, include=FALSE}
tb_outcomes_period <- tb_outcomes_period %>%
  mutate(
    completed = if_else(`Treatment Outcome` %in% c("C", "TC"), 1, 0)
  )

```



```{r, include=FALSE}
model_completion <- glm(
  completed ~ period,
  data = tb_outcomes_period,
  family = binomial
)


```

```{r, include=FALSE}
summary(model_completion)
```

```{r, include=FALSE}
library(broom)

or_table <- tidy(model_completion, exponentiate = TRUE, conf.int = TRUE)


```

```{r, include=FALSE}
# Clean the table and round numbers
or_table_clean <- or_table %>%
  mutate(
    estimate = round(estimate, 2),
    conf.low = round(conf.low, 2),
    conf.high = round(conf.high, 2),
    p.value = signif(p.value, 3),
    term = case_when(
      term == "(Intercept)" ~ "Baseline (Pre-COVID, Female, <15 years)",
      term == "periodCOVID" ~ "COVID period vs Pre-COVID",
      term == "periodPost-COVID" ~ "Post-COVID vs Pre-COVID",
      TRUE ~ term
    )
  ) %>%
  select(term, estimate, conf.low, conf.high, p.value)

```

```{r,Adjusted Odds Ratios for TB Treatment Completion, include=TRUE}
or_table_clean %>%
  kable(
    col.names = c("Variable", "Adjusted OR", "95% CI Lower", "95% CI Upper", "P-value"),
    caption = "Adjusted Odds Ratios for TB Treatment Completion (Univariate Model)"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center"
  )
```



```{r, include=FALSE}
tb_outcomes_period <- tb_outcomes_period %>%
  mutate(
    age_group = case_when(
      `Age on Registration` < 15 ~ "<15",
      `Age on Registration` >= 15 & `Age on Registration` < 25 ~ "15–24",
      `Age on Registration` >= 25 & `Age on Registration` < 45 ~ "25–44",
      `Age on Registration` >= 45 & `Age on Registration` < 65 ~ "45–64",
      `Age on Registration` >= 65 ~ "65+",
      TRUE ~ NA_character_
    )
  )
```

```{r, include=FALSE}
tb_outcomes_period <- tb_outcomes_period %>%
  mutate(
    period = factor(period, levels = c("Pre-COVID", "COVID", "Post-COVID")),
    Gender = factor(Gender),
    age_group = factor(age_group)
  )

```

```{r,include=FALSE}
model_multiv <- glm(
  completed ~ period + Gender + age_group,
  data = tb_outcomes_period,
  family = binomial
)

summary(model_multiv)

```

```{r, include=FALSE}
or_multiv <- tidy(
  model_multiv,
  exponentiate = TRUE,
  conf.int = TRUE
)
```


```{r include=FALSE}
or_multiv_clean <- or_multiv %>%
  mutate(
    term = case_when(
      term == "(Intercept)" ~ "Baseline (Pre-COVID, Female, <15 years)",
      term == "periodCOVID" ~ "COVID period vs Pre-COVID",
      term == "periodPost-COVID" ~ "Post-COVID vs Pre-COVID",
      term == "GenderMale" ~ "Male vs Female",
      term == "age_group15–24" ~ "Age 15–24 vs <15",
      term == "age_group25–44" ~ "Age 25–44 vs <15",
      term == "age_group45–64" ~ "Age 45–64 vs <15",
      term == "age_group65+" ~ "Age ≥65 vs <15",
      TRUE ~ term
    )
  )

```


```{r, include=TRUE}
or_multiv_clean %>%
  mutate(
    estimate = round(estimate, 2),
    conf.low = round(conf.low, 2),
    conf.high = round(conf.high, 2),
    p.value = signif(p.value, 3)
  ) %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  kable(
    col.names = c(
      "Variable",
      "Adjusted OR",
      "95% CI (Lower)",
      "95% CI (Upper)",
      "P-value"
    ),
    caption = "Adjusted Odds Ratios for TB Treatment Completion"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE
  )

```


